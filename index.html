<!DOCTYPE html>
<html>
<head>
  <title>Strava Cycling PWA</title>
  <meta name="viewport" content="width=device-width">
</head>
<body style="font-family: Arial; padding: 20px; max-width: 800px; margin: auto;">
  <h1>üö¥ Strava Cycling App</h1>
  
  <button onclick="connectStrava()" style="padding: 10px; font-size: 16px;">
    üîó Connect to Strava
  </button>
  
  <div id="status" style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; min-height: 50px;">
    Loading...
  </div>

  <script>
    const DOMAIN = 'my-strava-lay6.vercel.app';     // From Vercel dashboard
    const CLIENT_ID = '180222';              // From Strava dashboard

    function connectStrava() {
      const authUrl = `https://www.strava.com/oauth/authorize?` +
        `client_id=${CLIENT_ID}&` +
        `redirect_uri=https://${DOMAIN}/api/callback&` +
        `response_type=code&` +
        `scope=read_all,activity:read_all&approval_prompt=auto`;
      window.location.href = authUrl;
    }

    function updateStatus() {
      const connected = localStorage.getItem('strava_connected') === '1';
      const statusEl = document.getElementById('status');
      if (connected) {
        statusEl.innerHTML = `
          <strong>‚úÖ Connected to Strava!</strong><br>
          <button onclick="loadAllRides()" style="margin-top: 10px;">üìä Load All Rides</button>
        `;
      } else {
        statusEl.innerHTML = 'Click "Connect to Strava" to start. After auth, your /api/callback must store token and set localStorage.';
      }
    }

    async function loadAllRides() {
      const token = localStorage.getItem('strava_token');
      if (!token) {
        document.getElementById('status').innerHTML = '‚ùå No token! Reconnect via Strava.';
        return;
      }

      const statusEl = document.getElementById('status');
      statusEl.innerHTML = '‚è≥ Loading all your rides...';

      try {
        let allRides = [];
        let page = 1;
        let hasMore = true;

        // Fetch ALL pages (max 200 per page)
        while (hasMore) {
          const res = await fetch(`https://www.strava.com/api/v3/athlete/activities?page=${page}&per_page=50`, {
            headers: { Authorization: `Bearer ${token}` }
          });

          const rides = await res.json();
          if (!res.ok) throw new Error('API error: ' + (rides.message || res.statusText));
          
          allRides = allRides.concat(rides);
          hasMore = false;
//          hasMore = rides.length === 200;  // Continue if full page
          page++;
        }

        // Display results
        const recent = allRides.slice(0, 20);  // Show 20 most recent
        statusEl.innerHTML = `
          <h3>üìà ${allRides.length} total rides loaded!</h3>
          <h4>Most Recent:</h4>
          <ul style="max-height: 400px; overflow: auto;">
            ${recent.map(r => `
              <li style="margin: 8px 0; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                <strong>${r.name}</strong><br>
                ${(r.distance/1000).toFixed(1)}km ‚Ä¢ 
                ${Math.round(r.moving_time/60)}min ‚Ä¢ 
                ${new Date(r.start_date).toLocaleDateString()} ‚Ä¢ 
                <em>${r.type}</em>
              </li>
            `).join('')}
          </ul>
          <p><em>${allRides.length - recent.length} older rides available</em></p>
        `;
      } catch (error) {
        statusEl.innerHTML = `<strong>‚ùå Error:</strong> ${error.message}<br>Token expired? Reconnect.`;
      }
    }

    // Auto-update status on page load
    updateStatus();
  </script>
</body>
</html>
